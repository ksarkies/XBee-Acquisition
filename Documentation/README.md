**Assembly and Testing**
----------------------

1. The following procedures and tests should be carried out during or following assembly of the boards.
2. Add a blob of solder to one pin of the device to be soldered. Holding the device with tweezers, carefully melt the solder and push the device against the pad. Adjust the position of the device until all pins line up with the respective pads, leaving space on the pad for the solder to flow. Solder another pad on the opposite end of the device. Then solder in all the remaining pins.
3. On the main board solder all the passive components in the power circuit, the regulator and the debug connector. Connect to the testboard via the 12 pin cable. Connect 6V-12V power and check for 3.3V at the electrolytic capacitor, the IC power pins and at the analogue optical circuit.
4. Solder in the op-amp. This needs to be done before the AVR as the presence of the debug connector and AVR will hinder it's insertion.
5. Solder in the AVR. Connect an AVR programmer to the testboard via the 6-pin cable. Connect 6V to 12V power to the testboard (**not the programmer** otherwise the CPU on the meter board can be damaged). See the image below. This will provide 12V power to the watermeter assembly and 5V power to the programmer. Note that the programmer has 220Ω protection resistors to allow the target to have a lower supply voltage.
6. Connect the RS232 serial port on the programmer to a PC. If a serial PC port is used, invoke the program “avrserialprog -P /dev/ttyS0 -b 38400” to activate the GUI. If a USB to serial adapter is used, the port will need to be changed to /dev/ttyUSB0 (or whatever port on which the adapter appears). Check that the programmer identifies the device as an ATTiny841.
7. In the GUI click on “Lock/Fuse”, and in the window untick “Divide Clock by 8”. Ensure that the “Clock Source Selection” bits read 0010 (where 0 means unticked and 1 means ticked). Click on “Write FBs”. Do not change the clock bits to any other setting as it will risk making the AVR and hence the board unusable. This provides an internal calibrated 8MHz clock used in all tests and operational states. The 1MHz divided clock rate will not support the serial baud rate needed. Close the application and relaunch. Check that the fuse setting has indeed been changed.
8. In the optical circuit solder the passive components, the BJT and the photodiode onto the top of the board looking through. The cathode is the wide pin on the BPW-34S and this is mounted on the side facing the outer rim of the board.
9. Solder the LED mount board with the LED, and the 3-pin socket under the main board. The SFH4056 has a marking on the back with the wide end being the cathode. Mount with the narrow end, the anode, facing the pins. Place three individual pins in the 3-pin socket and solder the ends to the LED board. Check that the optical circuit produces a signal at the testboard count pin with the slotted wheel spinning and the watermeter assembly mounted in a darkened housing.
10. **The following must not be carried out if the XBee is present in the watermeter assembly as it can damage the XBee serial ports.**
    * Locate the watermeter-echo-test firmware and upload to the AVR using “avrserialprog -n -P /dev/ttyS0 -b -w 38400 watermeter-echo-test.hex -v” or through the GUI. Link the W3 jumper on the testboard. Using a serial port monitor (e.g.putty) set to the 9600 baud rate, enter characters and verify that they are echoed back to the terminal.
    * Locate the watermeter-count-test firmware and upload to the AVR using “avrserialprog -n -P /dev/ttyS0 -b -w 38400 watermeter-count-test.hex -v” or through the GUI. Link the W3 jumper on the testboard. Attach the LED board and a slotted wheel and place in a darkened housing. Using a serial port monitor (e.g. putty) set to the 9600 baud rate, spin the slotted wheel and verify that consistent counts are being transmitted by the AVR.

!["Setup of test rig"](https://github.com/ksarkies/XBee-Acquisition/blob/master/Documentation/Test-Rig-Meter-Board-Testboard-AVR-Programmer.jpg )

K. Sarkies, 07 January 2017

